#!/usr/bin/env node
'use strict';

const logger = require('logger'),
    argv = require('yargs')
    .usage('Usage: stank [options]')

    .describe('debug', 'Turns on debug logging')
    .alias('debug', 'd')
    .boolean('debug')

    .describe('file', 'The file to analyze')
    .alias('file', 'f')
    .nargs('f', 1)

    //.describe('flags', 'A bitmask, specifies which types are captured')
    //.nargs('f', 1)

    .describe('html', 'Creates an html document of the analysis')
    .boolean('html')

    .describe('verbosity', 'The level of verbosity')
    .alias('v', 'v')
    .alias('vv', 'vv')

    .help('help')
    .alias('help', 'h')
    .argv,

    generator = require(
        `s/src/generator/${
            argv.html ? 'html' : 'log'
        }`
    ),

    // Unfortunately, a single -v returns a Boolean while multiples (-vv, -vvv) return an Array.
    verbosity = argv.v && Array.isArray(argv.v) ?
        argv.v.length :
            argv.v ?
                1 : 0,

    visitor = require('../src/visitor'),
    h = require('s/src/index'),
    file = argv.file;//,
    //flags = Number(argv.flags);

/*
visitor.setFlags(
    !isNaN(flags) ?
        flags :
        255
);
*/

// Logging is enabled by default.
if (!argv.debug) {
    logger.disable();
}

// Mixin our node type functions.
h.register(visitor);

if (!file) {
    const stdin = process.stdin;
    let buf = '';

    stdin.setEncoding('utf8');

    stdin.on('readable', () => {
        const chunk = stdin.read();

        if (chunk !== null) {
            buf += chunk;
        }
    });

    stdin.on('end', () => {
        h.makeTree(buf, generator, verbosity, true)
        .then(logger.raw)
        .catch(logger.error);
    });
} else {
    h.makeTree(file, generator, verbosity)
    .then(logger.raw)
    .catch(logger.error);
}

